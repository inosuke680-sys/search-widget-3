# UmaTen Restaurant Search Widget - Enterprise Edition

飲食店レビューサイト用のエンタープライズ向け高度な検索ウィジェットプラグインです。

## 機能 - Enterprise Edition

### 🎯 高度な検索機能

1. **複数条件での絞り込み**
   - カテゴリ、タグ、キーワードを同時に指定
   - すべての条件がAND検索で統合
   - 検索結果をより精密に絞り込み

2. **親子階層カテゴリ表示**
   - カテゴリを親カテゴリごとにグループ化
   - 親カテゴリ名をoptgroupとして表示
   - 子カテゴリはインデント表示

3. **タググループ化機能**
   - タグを属性別にグループ管理
   - 「料理ジャンル」「特徴・雰囲気」「価格帯」で分類
   - ラーメン、寿司などの属性で絞り込み
   - 管理画面で柔軟にグループ設定可能
   - **NEW**: すべてのタグを一括で有効化するオプション

4. **URLコンテキスト保持**
   - `/hokkaido/susukino/restaurant/` 形式のURLに完全対応
   - 現在の絞り込み状態を画面に表示
   - 地域・エリア・ジャンルを維持したまま追加検索

5. **フリーワード検索**
   - タイトル、本文、抜粋、カスタムフィールドを横断検索
   - 他の絞り込み条件と併用可能
   - SQLインジェクション対策、XSS対策を実装

6. **🛡️ DDoS攻撃対策・セキュリティ**
   - **レート制限**: IPアドレスごとに5分間に最大50リクエストまで許可（通常利用に影響なし）
   - **Nonce検証**: CSRF（クロスサイトリクエストフォージェリ）攻撃を防止
   - **入力バリデーション強化**: 危険なパターン（SQL、XSS）を自動除去
   - **プロキシ対応**: X-Forwarded-Forヘッダーを正しく処理
   - **キャッシュベース**: WordPressのトランジェントAPIを活用した効率的な制限

7. **📱 完璧なレスポンシブ対応（NEW）**
   - **デスクトップ**: 通常のウィジェット表示
   - **タブレット/スマホ**: 右下の浮動検索ボタン（FAB）
   - **モーダル検索**: ボタンタップで下からスライドアップ
   - **タッチ最適化**: 大きなボタン、スワイプで閉じる
   - **iOS対応**: ズーム無効化、Safe Area対応
   - **ダークモード**: システム設定に自動追従
   - **アクセシビリティ**: Escキーで閉じる、フォーカス管理

## インストール

### 自動デプロイ（本番環境向け・推奨）

SSHで本番サーバーに接続してから以下を実行：

```bash
# デプロイスクリプトをダウンロード
curl -o /tmp/deploy-umaten-v1.1.0.sh https://raw.githubusercontent.com/inosuke680-sys/search-widget-1/claude/fix-restaurant-redirect-bug-01UJripb6KV1eAEXQfXNfLPu/deploy-production.sh

# 実行権限を付与
chmod +x /tmp/deploy-umaten-v1.1.0.sh

# デプロイを実行（root権限が必要）
sudo /tmp/deploy-umaten-v1.1.0.sh
```

このスクリプトは以下を自動的に実行します：
- WordPress環境の自動検出
- 既存プラグインの自動バックアップ
- 最新版のダウンロードとインストール
- パーミッション設定（KUSANAGI対応）
- リライトルールの自動更新

### 手動インストール

1. プラグインフォルダをWordPressの`wp-content/plugins/`ディレクトリにアップロード
2. WordPress管理画面の「プラグイン」メニューからプラグインを有効化
3. 「外観」→「ウィジェット」から「飲食店検索ウィジェット」を配置

### FTPでのインストール

```bash
# プラグインディレクトリに移動
cd /path/to/wordpress/wp-content/plugins/

# プラグインフォルダをアップロード
# umaten-restaurant-search-widget フォルダをこの場所に配置
```

## 使い方

### ウィジェットの配置

1. WordPress管理画面にログイン
2. 「外観」→「ウィジェット」に移動
3. 「飲食店検索ウィジェット」を任意のウィジェットエリアにドラッグ&ドロップ
4. ウィジェット設定を調整

### ウィジェット設定項目

- **タイトル**: ウィジェットのタイトルを設定
- **範囲指定検索を有効化**: 検索範囲のドロップダウンを表示するかどうか
- **フリーワード検索を有効化**: キーワード入力フィールドを表示するかどうか
- **デフォルト検索範囲**: 初期表示時の検索範囲を設定

### カスタムタクソノミーの設定

このプラグインは以下のカスタムタクソノミーに対応しています：

- `region` (都道府県)
- `area` (エリア)
- `genre` (ジャンル)

これらのタクソノミーを使用する場合は、別途タクソノミーを登録してください。

#### タクソノミー登録例

```php
// functions.php に追加

// 都道府県タクソノミー
register_taxonomy('region', 'post', array(
    'label' => '都道府県',
    'hierarchical' => true,
    'rewrite' => array('slug' => 'region'),
    'show_admin_column' => true,
));

// エリアタクソノミー
register_taxonomy('area', 'post', array(
    'label' => 'エリア',
    'hierarchical' => true,
    'rewrite' => array('slug' => 'area'),
    'show_admin_column' => true,
));

// ジャンルタクソノミー
register_taxonomy('genre', 'post', array(
    'label' => 'ジャンル',
    'hierarchical' => true,
    'rewrite' => array('slug' => 'genre'),
    'show_admin_column' => true,
));
```

### リライトルールの反映

プラグインを有効化した後、パーマリンク設定を保存してリライトルールを反映してください。

1. 「設定」→「パーマリンク設定」に移動
2. 「変更を保存」ボタンをクリック

## カスタマイズ

### スタイルのカスタマイズ

プラグインのスタイルをカスタマイズする場合は、テーマの`style.css`に以下のようなCSSを追加してください：

```css
/* ウィジェットのカスタマイズ例 */
.umaten-search-widget {
    background: #f9f9f9;
    border-radius: 10px;
}

.umaten-search-button {
    background: #ff6b6b;
}

.umaten-search-button:hover {
    background: #ee5a52;
}
```

### 検索結果ページのカスタマイズ

検索結果を表示するためのカスタムテンプレートを作成できます：

1. テーマディレクトリに`search.php`を作成
2. または`archive-{post_type}.php`を作成

### フックとフィルター

#### カスタム検索クエリのフック

```php
// 検索クエリをカスタマイズ
add_filter('pre_get_posts', function($query) {
    if (!is_admin() && $query->is_main_query() && $query->get('umaten_custom_search')) {
        // カスタムクエリの追加処理
        $query->set('posts_per_page', 20);
    }
    return $query;
});
```

## トラブルシューティング

### 検索が機能しない

1. パーマリンク設定を保存し直す
2. プラグインを無効化してから再度有効化
3. 他のプラグインとの競合を確認

### スタイルが適用されない

1. ブラウザのキャッシュをクリア
2. テーマのCSSが優先されていないか確認
3. ブラウザの開発者ツールでCSSの読み込みを確認

### リライトルールが機能しない

1. 「設定」→「パーマリンク設定」から設定を保存
2. `.htaccess`ファイルの書き込み権限を確認
3. サーバーの`mod_rewrite`が有効か確認

## 必要要件

- WordPress 5.0 以上
- PHP 7.2 以上
- MySQL 5.6 以上

## 推奨環境

- WordPress 最新版
- PHP 8.0 以上
- KUSANAGI環境

## ライセンス

GPL v2 or later

## サポート

問題や質問がある場合は、以下にお問い合わせください：

- ウェブサイト: https://umaten.jp
- GitHub Issues: (リポジトリURL)

## 更新履歴

### Version 1.1.0 (2025-11-16)
- **【重要】リダイレクトバグ修正**: `/hokkaido/hakodate/ramen`などの3セグメントURLでトップページにリダイレクトされる不具合を解決
- **直接URLアクセス対応**: リライトルール経由の直接URLアクセス（検索フォームを経由しないアクセス）に完全対応
- **クエリ処理の改善**: `umaten_region`, `umaten_area`, `umaten_genre`クエリ変数の処理ロジックを強化
- **404エラー処理の最適化**: 無効なタクソノミーURLへのアクセス時に適切に404ページを表示
- **セキュリティの向上**: 直接URLアクセス時のNonceチェックを適切にバイパス（リライトルール経由では不要）
- **タクソノミータームの検証強化**: `is_wp_error()`チェックを追加し、エラーハンドリングを改善
- **WordPressクエリフラグの設定**: `is_archive`と`is_home`フラグを適切に設定し、テンプレート選択を最適化
- **安定性の向上**: 1.0.0のすべての機能を維持しつつ、上位互換性を確保

### Version 1.0.0 (2024-11-12)
- 初回リリース
- 基本的な検索機能を実装
- カテゴリ・タグ自動取得機能
- 範囲指定検索機能
- フリーワード検索機能
- カスタムリライトルール対応

## クレジット

開発: UmaTen Development Team

## スクリーンショット

(スクリーンショットは別途追加してください)

## FAQ

### Q: カスタム投稿タイプでも使用できますか？

A: はい、カスタム投稿タイプでも使用できます。ただし、カスタムタクソノミーを適切に設定する必要があります。

### Q: 複数のウィジェットを配置できますか？

A: はい、複数のウィジェットを異なる設定で配置することができます。

### Q: 検索結果の表示件数を変更できますか？

A: はい、WordPressの設定またはカスタムコードで変更できます。`pre_get_posts`フックを使用してください。

### Q: AJAXでの検索に対応していますか？

A: 現在のバージョンではページ遷移型の検索ですが、JavaScriptファイルにAJAX検索のベースコードが含まれています。カスタマイズすることでAJAX検索を実装できます。
